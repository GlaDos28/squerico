<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>GlaDos's testing page</title>
        <script src="js/pixi.js"></script>
    </head>
    <body>
    
    <script src="js/Core.js"></script>
    
    <script type="text/javascript">
	
	const DELAY_TURN_TIME = 10;
	const DELAY_DRAW_TIME = 2;
	const FIELD = { squareSize: 48,
	                squareOffset: { x: 16.25, y: 12.4 },
	                start: { x: 20,
				 y: 50 },
			end: { x: 50 + a.m * 64,
			       y: 50 + a.n * 60 } };
	const BACKGROUND_COLOR = 0x1099bb;
	const BADGE = { size: 75, pos: [ { x: 1175, y: 75 }, { x: 1175, y: 175 }, { x: 1175, y: 275 } ] };
	
	//**********************************************
	
        var renderer = PIXI.autoDetectRenderer(1300, 1150, { backgroundColor: BACKGROUND_COLOR });
        document.body.appendChild(renderer.view);
        
        var stage = new PIXI.Container();
        stage.interactive = true;
        
        //**********************************************
        
        var logo = new PIXI.Sprite(PIXI.Texture.fromImage('assets/idp.jpg'));
        
        logo.anchor.x = 0.8;
        logo.anchor.y = 0.8;
        
        logo.scale.set(0.285);
        
        logo.position.x = 1256;
        logo.position.y = 1076;
        
        //**********************************************
        
        const square = [ { texture: PIXI.Texture.fromImage('' /* assets/block-empty.png */) },
                         { texture: PIXI.Texture.fromImage('assets/block-none.png')  },
                         { texture: PIXI.Texture.fromImage('assets/block-copy.png')  } ];
        
        //**********************************************
        
        var field = new Array(a.m);
        
        for (var i = 0; i < a.m; i++) {
		field[i] = new Array(a.n);
		
		for (var j = 0; j < a.n; j++) {
			field[i][j] = new PIXI.Sprite(PIXI.Texture.fromImage('assets/block-empty.png'));
			field[i][j].position.x = FIELD.start.x + 50 + (FIELD.squareSize + FIELD.squareOffset.x) * j;
			field[i][j].position.y = FIELD.start.y + 50 + (FIELD.squareSize + FIELD.squareOffset.y) * i;
		}
        }
        
        //**********************************************
        
        var graphics = new PIXI.Graphics();
        var timerTurn = 0;
        var timerDraw = 0;
        var pause = false;
        var paintBlock = 0;
        
        //**
        
        var interactRect = new PIXI.Graphics();
        interactRect.lineStyle(0, 0x000000, 1);
	interactRect.beginFill(BACKGROUND_COLOR, 1);
	interactRect.drawRect(FIELD.start.x, FIELD.start.y, FIELD.end.x - FIELD.start.x, FIELD.end.y - FIELD.start.y);
	interactRect.endFill();
        
        //**
        
        var basicText = new PIXI.Text("Pause");
        
	basicText.x = (FIELD.start.x + FIELD.end.x) / 2;;
	basicText.y = 10;
	
	basicText.interactive = true;
	
	basicText.on('click', onPauseClick);
	basicText.on('tap', onPauseClick);
	
	//**********************************************
	
	var background = { fieldBG: new PIXI.Sprite(PIXI.Texture.fromImage('assets/game-field.png')),
	                   g: new PIXI.Graphics(),
	                   badge: new Array(square.length) };
	
	background.fieldBG.position.x = FIELD.start.x;
	background.fieldBG.position.y = FIELD.start.y;
	
	background.g.lineStyle(4, 0x0000DF, 1);
	background.g.beginFill(BACKGROUND_COLOR, 1);
	background.g.drawRect(1145, 50, 140, 1055);
	background.g.endFill();
	
	for (var i = 0; i < square.length; i++) {
		background.badge[i] = new PIXI.Sprite(square[i].texture);
		background.badge[i].anchor.x = -0.1;
		background.badge[i].anchor.y = -0.1;
		background.badge[i].position.x = BADGE.pos[i].x;
		background.badge[i].position.y = BADGE.pos[i].y;
	}
	
	//**********************************************
	
	stage.addChild(interactRect);
	stage.addChild(background.fieldBG);
	stage.addChild(background.g);
	stage.addChild(basicText);
	stage.addChild(logo);
	
	for (var i = 0; i < a.m; i++)
		for (var j = 0; j < a.n; j++)
			stage.addChild(field[i][j]);
	
	for (var i = 0; i < square.length; i++)
		stage.addChild(background.badge[i]);
	
	stage.on('click', onClick);
	stage.on('tap', onClick);
	
	//**********************************************
	
	function inRect(p, rectP, w, h) {
		return p.x >= rectP.x     &&
		       p.y >= rectP.y     &&
		       p.x <= rectP.x + w &&
		       p.y <= rectP.y + h;
	}
	
	//**********************************************
	
	function onPauseClick(event) {
		pause = !pause;
	}
	
	function onClick(event) {
		var p = event.data.getLocalPosition(this)
		
		for (var i = 0; i < BADGE.pos.length; i++)
			if (inRect(p, BADGE.pos[i], BADGE.size, BADGE.size)) {
				paintBlock = i;
				break;
			}
		
		if (	p.x < FIELD.start.x ||
			p.y < FIELD.start.y ||
			p.x > FIELD.end.x   ||
			p.y > FIELD.end.y) 
		    return;
		
		p.x -= FIELD.start.x + 46;
		p.y -= FIELD.start.y + 50;
		
		p.x /= FIELD.squareSize + FIELD.squareOffset.x;
		p.y /= FIELD.squareSize + FIELD.squareOffset.y;
		
		var intX = Math.floor(p.x);
		var intY = Math.floor(p.y);
		
		a.c[intY][intX] = paintBlock;
	}
	
	//**********************************************
	
        animate();
        function animate() {
		if (!pause)
			timerTurn++;
		
		timerDraw++;
		
		if (timerDraw >= DELAY_DRAW_TIME) {
			timerDraw = 0;
			
			for (var i = 0; i < a.m; i++)
				for (var j = 0; j < a.n; j++)
					field[i][j].texture = square[a.c[i][j]].texture;
			
			graphics = new PIXI.Graphics();
			graphics.lineStyle(2, 0x00FF00, 1);
			graphics.beginFill(0x000000, 0);
			graphics.drawRect(BADGE.pos[paintBlock].x, BADGE.pos[paintBlock].y, BADGE.size, BADGE.size);
			graphics.endFill();
		}
		
		if (timerTurn >= DELAY_TURN_TIME) {
			timerTurn = 0;
			turnAutomaton(a);
		}
		
		stage.addChild(graphics);
		
		requestAnimationFrame(animate);
		renderer.render(stage);
		
		stage.removeChild(graphics);
        }
        
    </script>

  </body>
</html>

